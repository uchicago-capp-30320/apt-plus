{% load static %}

<div id="map" style="width: 100vw; height: 100vh;"></div>

<script>
  // Initialize MapLibre map (STATIC at first)
  var map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
    center: [-87.5995, 41.7925],
    zoom: 13.6,
    interactive: false
  });

  var currentMarker = null; // To store the marker

  async function placeAddress(response) {
    /**
    * Places the submitted address on the map.
    * 
    * @param {response} - JSON response from `/fetch_all_data` with lat, lon
    * @returns {void} - Modifies the map in place by adding a marker 
    */
    // Input error handling
    if (!response) return;

    // Handle both string and object inputs
    const data = typeof response === 'string' ? JSON.parse(response) : response;

    // Check for different possible formats
    let coords;
    if (data.address_geojson && data.address_geojson.features) {
      // Format for test data
      coords = data.address_geojson.features[0].geometry.coordinates;
    } else if (data.features && data.features.length > 0) {
      // Format for GeoJSON from endpoint
      coords = data.features[0].geometry.coordinates;
    }

    const lat = parseFloat(coords[1]);
    const lon = parseFloat(coords[0]);

    console.log(`Found: ${lat}, ${lon}`);

    // Enable map interaction
    enableMapInteraction(map);

    // Move to the address
    map.flyTo({
      center: [lon, lat],
      zoom: 15
    });

    // Add marker
    currentMarker = new maplibregl.Marker({ color: 'yellow' })
      .setLngLat([lon, lat])
      .addTo(map);
  }

  function enableMapInteraction(map) {
    /**
      * Helper function to enable map interaction on a delay.
      * 
      * @param {map} - map object to enable interactions
      * @returns {void}, no return
    */
    if (!map.dragPan.isEnabled()) map.dragPan.enable();
    if (!map.scrollZoom.isEnabled()) map.scrollZoom.enable();
    if (!map.boxZoom.isEnabled()) map.boxZoom.enable();
    if (!map.keyboard.isEnabled()) map.keyboard.enable();
    if (!map.doubleClickZoom.isEnabled()) map.doubleClickZoom.enable();
    if (!map.touchZoomRotate.isEnabled()) map.touchZoomRotate.enable();
    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
  }

</script>


<!-- Groceries -->
<script>
  var groceryMarkers = [];
  var busStopMarkers = [];

  function displayGroceries() {

    // Get distance filter
    let filterSelect = document.getElementById("distanceFilter");
    let distanceMin = filterSelect ? parseInt(filterSelect.value) : 5;

    // Clear grocery markers (otherwise they keep overlaying)
    groceryMarkers.forEach(m => m.remove());
    groceryMarkers = [];

    var data = {
      "address": "123 Main St",
      "walking_time": 5,
      "grocery_geojson": {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "geometry": {
              "type": "Point",
              "coordinates": [-87.587851, 41.801710]
            },
            "properties": {
              "name": "Whole Foods",
              "distance_min": 4,
              "address": "1521 E Hyde Park Blvd"
            }
          },
          {
            "type": "Feature",
            "geometry": {
              "type": "Point",
              "coordinates": [-87.588746, 41.796868]
            },
            "properties": {
              "name": "Trader Joe's",
              "distance_min": 6,
              "address": "55th & Lake Park"
            }
          }
        ]
      }
    };

    var features = data.grocery_geojson.features;

    for (let i = 0; i < features.length; i++) {
      let coords = features[i].geometry.coordinates;
      let props = features[i].properties;

      // Apply filter
      if (props.distance_min > distanceMin) continue;

      // SHow name and address
      let popup = new maplibregl.Popup({ offset: 25 }).setHTML(
      `<strong>${props.name}</strong><br>${props.address}`
      );

      let marker = new maplibregl.Marker({ color: 'green' })
        .setLngLat(coords)
        .addTo(map);

      marker.getElement().addEventListener('mouseenter', function () {
      popup.setLngLat(coords).addTo(map);
    });

    marker.getElement().addEventListener('mouseleave', function () {
      popup.remove();
    });

    groceryMarkers.push(marker);
    }  
  }


// Bus stops
  function displayBusStops() {

  // Get distance filter
  let filterSelect = document.getElementById("distanceFilter");
  let distanceMin = filterSelect ? parseInt(filterSelect.value) : 5;
  
  // Clear bus stops markers (otherwise they keep overlaying)
  busStopMarkers.forEach(m => m.remove());
  busStopMarkers = [];

  var data = {
    "address": "123 Main St",
    "walking_time": 5,
    "bus_stops_geojson": {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": { "type": "Point", "coordinates": [-87.5960, 41.7942] },
          "properties": {
            "stop_name": "Lake Park & 56th",
            "distance_min": 13,
            "routes": ["2", "6", "28"],
            "stop_id": "BUS12345"
          }
        },
        {
          "type": "Feature",
          "geometry": { "type": "Point", "coordinates": [-87.5911, 41.8005] },
          "properties": {
            "stop_name": "Hyde Park & 53rd",
            "distance_min": 4,
            "routes": ["15", "55"],
            "stop_id": "BUS67890"
          }
        }
      ]
    }
  };

  var features = data.bus_stops_geojson.features;

  for (let i = 0; i < features.length; i++) {
    let coords = features[i].geometry.coordinates;
    let props = features[i].properties;

    if (props.distance_min > distanceMin) continue;

    let popup = new maplibregl.Popup({ offset: 25 }).setHTML(
      `<strong>${props.stop_name}</strong><br>Routes: ${props.routes.join(", ")}`
    );

    let marker = new maplibregl.Marker({ color: 'blue' })
      .setLngLat(coords)
      .addTo(map);

    marker.getElement().addEventListener('mouseenter', function () {
      popup.setLngLat(coords).addTo(map);
    });

    marker.getElement().addEventListener('mouseleave', function () {
      popup.remove();
    });

    busStopMarkers.push(marker);
  }
}

</script>

<script>
  document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'groceriesButton') {
      console.log("Groceries button clicked");
      displayGroceries();
    }
  });
</script>

<script>
  document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'busStopsButton') {
      console.log("Bus Stops button clicked");
      displayBusStops();
    }
  });
</script>