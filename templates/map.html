{% load static %}

<!-- Map container -->
<div id="test-data" data-response='{"cleaned_address": "Testing Address - to Display",    
      "property_id": "Add0001",
      "address_geojson": {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "geometry": {
              "type": "Point",
              "coordinates": [41.80267967125594, -87.58626497875387]
            },
            "properties": {
              "label": "Testing Address - Label"
            }
          }
        ]
      }
    }'>
</div>
<div id="map" style="width: 100vw; height: 100vh;"></div>

<script>
  // Initialize MapLibre map (STATIC at first)
  var map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
    center: [-87.5995, 41.7925],
    zoom: 13.6, // Change depending on the final map size (see style)
    interactive: false // Starts as static, until user types the address
  });

  var currentMarker = null; // To store the marker

  async function placeAddress(response) {
    /**
    * Places the submitted address on the map.
    * 
    * @param {response} - JSON response from `/fetch_all_data` with lat, lon
    * @returns {void} - Modifies the map in place by adding a marker 
    */
    // Input error handling
    if (!response) return;

    // Parse data from input - TODO: check if await is needed
    const data = JSON.parse(response);
    const coords = data["address_geojson"]["features"][0]["geometry"]["coordinates"];

    const lat = parseFloat(coords[0]);
    const lon = parseFloat(coords[1]);

    console.log(`Found: ${lat}, ${lon}`);

    // Enable map interaction
    map.dragPan.enable();
    map.scrollZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    map.doubleClickZoom.enable();
    map.touchZoomRotate.enable();

    // Move to the address
    map.flyTo({
      center: [lon, lat],
      zoom: 15
    });

    // Add marker
    currentMarker = new maplibregl.Marker({ color: 'yellow' })
      .setLngLat([lon, lat])
      .addTo(map);
  }

  function extractResponse(id, attr) {
    /**
     * Shallow function to parse and grab a response format so that the content
     * can placed in the map. Currently assumes that the response is stored as
     * a tag in a div.
     * 
     * @param {id} - id of the object with the data.
     * @param {attr} - name of the attribute with the response tag
     * @returns {json} - address response stored as JSON.
    */

    elem = document.getElementById(`${id}`);
    if (!elem) {
      console.error(`Cannot find element ${id}`);
      return {}; // Empty JSON
    }

    const attrValue = elem.getAttribute(attr);
    // Enforce returning something JSON formatted: 
    // Ref: https://stackoverflow.com/a/27690825
    try {
      return attrValue;
    } catch (e) {
      console.error(`Failed to parse JSON from attribute ${attr}:`, e);
      return {};
    }
  }

  // To-do determine if necessary
  const response = extractResponse("test-data", "data-response")
  placeAddress(response);
</script>

</body>

</html>